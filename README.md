# FlowCheck - ç½‘ç»œæµé‡æ£€æµ‹ä¸åˆ†æç³»ç»Ÿ

FlowCheck æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ç½‘ç»œæµé‡æ£€æµ‹ä¸åˆ†æç³»ç»Ÿï¼Œç”¨äºè¯†åˆ«ç½‘ç»œåè®®ã€æå–åŸŸåä¿¡æ¯ï¼Œå¹¶æä¾› DNS ç¼“å­˜åŠŸèƒ½ã€‚

## é¡¹ç›®ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **åè®®æ£€æµ‹**ï¼šæ”¯æŒ DNSã€HTTPã€HTTPS/TLSã€QUICã€SSHã€FTPã€SMTPã€IMAPã€POP3 ç­‰å¤šç§åè®®
- âœ… **åŸŸåæå–**ï¼šä» DNS æŸ¥è¯¢/å“åº”ã€TLS SNIã€HTTP Host å¤´ä¸­æå–åŸŸåä¿¡æ¯
- âœ… **DNS ç¼“å­˜**ï¼šæ™ºèƒ½ DNS å“åº”ç¼“å­˜ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡
- âœ… **IP-åŸŸåæ˜ å°„**ï¼šç»´æŠ¤ IP åœ°å€åˆ°åŸŸåçš„æ˜ å°„å…³ç³»
- âœ… **æµé‡å†³ç­–**ï¼šåŸºäºåŸŸåå’Œåè®®çš„æµé‡æ§åˆ¶å†³ç­–

### æŠ€æœ¯ç‰¹æ€§
- ğŸš€ **é«˜æ€§èƒ½**ï¼šC++17 å®ç°ï¼Œé›¶æ‹·è´è®¾è®¡
- ğŸ”’ **çº¿ç¨‹å®‰å…¨**ï¼šæ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è®¿é—®
- ğŸ¯ **å•ä¾‹æ¨¡å¼**ï¼šå…¨å±€å…±äº« DNS ç¼“å­˜
- ğŸ“¦ **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¸…æ™°çš„åˆ†å±‚æ¶æ„

## é¡¹ç›®ç»“æ„

```
flowcheck/
â”œâ”€â”€ dns/                    # DNS è§£ææ¨¡å—
â”‚   â”œâ”€â”€ dns_cache.cpp      # DNS å“åº”ç¼“å­˜
â”‚   â”œâ”€â”€ dns_message.cpp    # DNS æ¶ˆæ¯è§£æ
â”‚   â””â”€â”€ *.hpp              # å¤´æ–‡ä»¶
â”œâ”€â”€ protocol/              # åè®®è§£æå™¨
â”‚   â”œâ”€â”€ http_parser.cpp    # HTTP åè®®
â”‚   â”œâ”€â”€ tls_parser.cpp     # TLS/HTTPS åè®®
â”‚   â”œâ”€â”€ quic_parser.cpp    # QUIC åè®®
â”‚   â”œâ”€â”€ ssh_parser.cpp     # SSH åè®®
â”‚   â””â”€â”€ ...                # å…¶ä»–åè®®
â”œâ”€â”€ flow/                  # æµé‡ç®¡ç†æ ¸å¿ƒ
â”‚   â”œâ”€â”€ flow_engine.cpp    # æµé‡å¼•æ“ï¼ˆå•ä¾‹ï¼‰
â”‚   â”œâ”€â”€ flow_detector.cpp  # åè®®æ£€æµ‹å™¨
â”‚   â”œâ”€â”€ flow_dns.cpp       # DNS å¤„ç†å¼•æ“
â”‚   â””â”€â”€ flow_defines.cpp   # åŸºç¡€å®šä¹‰
â”œâ”€â”€ tests/                 # æµ‹è¯•ç”¨ä¾‹
â”‚   â”œâ”€â”€ test_main.cpp              # åŸºç¡€åŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ test_dns_mapping.cpp       # DNS æ˜ å°„æµ‹è¯•
â”‚   â”œâ”€â”€ test_with_data.cpp         # çœŸå®æ•°æ®æµ‹è¯•
â”‚   â”œâ”€â”€ test_data_advanced.cpp     # é«˜çº§ç»Ÿè®¡æµ‹è¯•
â”‚   â””â”€â”€ test_analyze_failures.cpp  # å¤±è´¥åˆ†ææµ‹è¯•
â”œâ”€â”€ docs/                  # é¡¹ç›®æ–‡æ¡£
â”‚   â”œâ”€â”€ æµ‹è¯•è¯´æ˜.md        # æµ‹è¯•æ–‡æ¡£
â”‚   â”œâ”€â”€ æ¶æ„è®¾è®¡.md        # æ¶æ„æ–‡æ¡£
â”‚   â””â”€â”€ APIæ–‡æ¡£.md         # API æ–‡æ¡£
â”œâ”€â”€ scripts/               # å·¥å…·è„šæœ¬
â”‚   â”œâ”€â”€ scan_invalid_dirs.sh   # æ‰«ææ— æ•ˆç›®å½•
â”‚   â””â”€â”€ clean_invalid_dirs.sh  # æ¸…ç†æ— æ•ˆç›®å½•
â”œâ”€â”€ data/                  # æµ‹è¯•æ•°æ®
â”‚   â”œâ”€â”€ tcp/              # TCP æµæ•°æ®
â”‚   â””â”€â”€ udp/              # UDP æµæ•°æ®
â”œâ”€â”€ build/                 # ç¼–è¯‘è¾“å‡ºç›®å½•
â”œâ”€â”€ CMakeLists.txt        # CMake é…ç½®
â””â”€â”€ README.md             # æœ¬æ–‡ä»¶
```

## å¿«é€Ÿå¼€å§‹

### ç¼–è¯‘é¡¹ç›®

```bash
# åˆ›å»ºç¼–è¯‘ç›®å½•
mkdir -p build
cd build

# é…ç½®å’Œç¼–è¯‘
cmake ..
make

# ç¼–è¯‘æˆåŠŸåä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š
# - libdns_lib.a          DNS åº“
# - libprotocol_lib.a     åè®®è§£æåº“
# - libflow_lib.a         æµé‡ç®¡ç†åº“
# - flowcheck_test        åŸºç¡€æµ‹è¯•ç¨‹åº
# - test_dns_mapping      DNS æ˜ å°„æµ‹è¯•
# - test_with_data        çœŸå®æ•°æ®æµ‹è¯•
# - test_data_advanced    é«˜çº§ç»Ÿè®¡æµ‹è¯•
# - test_analyze_failures å¤±è´¥åˆ†ææµ‹è¯•
```

### è¿è¡Œæµ‹è¯•

```bash
cd build

# è¿è¡ŒåŸºç¡€åŠŸèƒ½æµ‹è¯•
./flowcheck_test

# è¿è¡Œ DNS æ˜ å°„æµ‹è¯•
./test_dns_mapping

# è¿è¡ŒçœŸå®æ•°æ®æµ‹è¯•
./test_with_data

# è¿è¡Œé«˜çº§ç»Ÿè®¡æµ‹è¯•ï¼ˆæ¨èï¼‰
./test_data_advanced

# è¿è¡Œå¤±è´¥åˆ†ææµ‹è¯•
./test_analyze_failures
```

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç”¨æ³•

```cpp
#include "flow/flow_engine.hpp"
#include "flow/flow_defines.h"

// è·å– FlowEngine å•ä¾‹
FlowEngine& engine = FlowEngine::getInstance();

// åˆ›å»ºæµä¸Šä¸‹æ–‡
FlowContext ctx;
ctx.session_id = 12345;
ctx.dst_ip = FlowIP::fromString("8.8.8.8");
ctx.dst_port = 53;
ctx.flow_type = FlowType::UDP;

// å¤„ç†å‡ºç«™æ•°æ®åŒ…
PacketView pkt;
pkt.data = packet_data;
pkt.len = packet_size;

// å¯¹äº DNS æŸ¥è¯¢ï¼Œå¯ä»¥è·å–ç¼“å­˜å“åº”
PacketView response;
if (engine.flowSend(ctx, pkt, response)) {
    // ç¼“å­˜å‘½ä¸­ï¼Œresponse åŒ…å« DNS å“åº”
    send_to_client(response.data, response.len);
} else {
    // ç¼“å­˜æœªå‘½ä¸­ï¼Œè½¬å‘åˆ°ä¸Šæ¸¸ DNS
    forward_to_upstream(pkt.data, pkt.len);
}

// å¤„ç†å…¥ç«™æ•°æ®åŒ…ï¼ˆDNS å“åº”ï¼‰
engine.flowRecv(ctx, response_pkt);

// æ£€æŸ¥æ˜¯å¦æå–åˆ°åŸŸå
if (ctx.hasDomain()) {
    for (const auto& domain : ctx.domains) {
        std::cout << "åŸŸå: " << domain << std::endl;
    }
}
```

### DNS IP-åŸŸåæ˜ å°„

```cpp
// è·å– DNS å¼•æ“
DNSEngine& dns = engine.getDNSEngine();

// æŸ¥è¯¢ IP å¯¹åº”çš„åŸŸå
std::vector<std::string> domains = dns.getDomainsForIP("220.181.174.34");
for (const auto& domain : domains) {
    std::cout << "åŸŸå: " << domain << std::endl;
}

// æ¸…é™¤ç¼“å­˜
dns.clearCache();
```

## æ€§èƒ½æŒ‡æ ‡

åŸºäº 1068 ä¸ªçœŸå®ç½‘ç»œæµçš„æµ‹è¯•ç»“æœï¼š

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ€»æµæ•° | 1068 |
| æ€»æ•°æ®åŒ… | 28,000+ |
| **åŸŸåæå–æˆåŠŸç‡** | **99%** |
| DNS æµè¯†åˆ«ç‡ | 100% |
| HTTPS æµè¯†åˆ«ç‡ | 100% |
| HTTP æµè¯†åˆ«ç‡ | 100% |

### åè®®æ”¯æŒ

| åè®® | ç«¯å£ | åŸŸåæå– | çŠ¶æ€ |
|------|------|----------|------|
| DNS | 53 | âœ… | å®Œå…¨æ”¯æŒ |
| HTTP | 80 | âœ… | å®Œå…¨æ”¯æŒ |
| HTTPS/TLS | 443 | âœ… | å®Œå…¨æ”¯æŒ |
| QUIC | 443 | âœ… | å®Œå…¨æ”¯æŒ |
| SSH | 22 | âŒ | åè®®é™åˆ¶ |
| FTP | 21 | âš ï¸ | éƒ¨åˆ†æ”¯æŒ |
| SMTP | 25 | âš ï¸ | éƒ¨åˆ†æ”¯æŒ |
| IMAP | 143 | âš ï¸ | éƒ¨åˆ†æ”¯æŒ |
| POP3 | 110 | âš ï¸ | éƒ¨åˆ†æ”¯æŒ |

## æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         FlowEngine (å•ä¾‹)            â”‚
â”‚  - æµé‡ç”Ÿå‘½å‘¨æœŸç®¡ç†                   â”‚
â”‚  - åè®®æ£€æµ‹è°ƒåº¦                       â”‚
â”‚  - å†³ç­–åˆ¶å®š                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚              â”‚
           â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Detector   â”‚  â”‚  DNSEngine   â”‚
â”‚  åè®®æ£€æµ‹å™¨   â”‚  â”‚  DNS å¤„ç†å™¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚              â”‚
           â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Protocol Parsers              â”‚
â”‚  HTTP â”‚ TLS â”‚ QUIC â”‚ SSH â”‚ ...      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

1. **FlowEngine**ï¼šæµé‡å¼•æ“ï¼Œå•ä¾‹æ¨¡å¼ï¼Œç®¡ç†æ•´ä¸ªæµé‡å¤„ç†æµç¨‹
2. **Detector**ï¼šåè®®æ£€æµ‹å™¨ï¼Œè¯†åˆ«ç½‘ç»œåè®®ç±»å‹
3. **DNSEngine**ï¼šDNS å¤„ç†å¼•æ“ï¼Œæä¾› DNS ç¼“å­˜å’Œ IP-åŸŸåæ˜ å°„
4. **Protocol Parsers**ï¼šå„ç§åè®®è§£æå™¨ï¼Œæå–åŸŸåä¿¡æ¯

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°åè®®æ”¯æŒ

1. åœ¨ `protocol/` ç›®å½•åˆ›å»ºæ–°çš„è§£æå™¨
2. å®ç°åè®®æ£€æµ‹å’ŒåŸŸåæå–é€»è¾‘
3. åœ¨ `flow_detector.cpp` ä¸­æ³¨å†Œæ–°åè®®
4. æ·»åŠ æµ‹è¯•ç”¨ä¾‹

### ä»£ç è§„èŒƒ

- C++17 æ ‡å‡†
- ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç†å†…å­˜
- éµå¾ª RAII åŸåˆ™
- çº¿ç¨‹å®‰å…¨è®¾è®¡
- ä¸­æ–‡æ³¨é‡Š

## æ–‡æ¡£

è¯¦ç»†æ–‡æ¡£è¯·å‚è€ƒ `docs/` ç›®å½•ï¼š

### ä¸»è¦æ–‡æ¡£
- [æµ‹è¯•è¯´æ˜](docs/æµ‹è¯•è¯´æ˜.md) - æµ‹è¯•ç”¨ä¾‹å’Œä½¿ç”¨æ–¹æ³•
- [æ¶æ„è®¾è®¡](docs/æ¶æ„è®¾è®¡.md) - ç³»ç»Ÿæ¶æ„å’Œè®¾è®¡æ€è·¯
- [APIæ–‡æ¡£](docs/APIæ–‡æ¡£.md) - API æ¥å£è¯´æ˜
- [é¡¹ç›®ç»“æ„](docs/é¡¹ç›®ç»“æ„.md) - ç›®å½•ç»“æ„å’Œæ¨¡å—è¯´æ˜
- [ç¼–è¯‘è¯´æ˜](docs/ç¼–è¯‘è¯´æ˜.md) - ç¼–è¯‘é…ç½®å’Œä½¿ç”¨æŒ‡å—

### å¼€å‘æ—¥å¿—
- [å¼€å‘æ—¥å¿—](docs/å¼€å‘æ—¥å¿—/) - è®¾è®¡å†³ç­–å’Œæ”¹è¿›è®°å½•

## è®¸å¯è¯

Copyright Â© 2026 WireGuard LLC. All rights reserved.

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## è”ç³»æ–¹å¼

- é¡¹ç›®ç»´æŠ¤è€…ï¼šjacky
- åˆ›å»ºæ—¥æœŸï¼š2026/2/9

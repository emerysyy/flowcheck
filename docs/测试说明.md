# FlowCheck 测试说明

本项目包含多个测试程序，用于验证 FlowEngine 的功能。

## 测试程序

### 1. flowcheck_test
基础功能测试，包括：
- 单例模式测试
- DNS 流处理
- HTTPS 流处理
- HTTP 多域名处理
- 流生命周期测试
- 协议检测测试

运行方式：
```bash
cd build
./flowcheck_test
```

### 2. test_dns_mapping
DNS IP-域名映射测试，包括：
- 单个域名映射
- 多个域名映射到同一 IP
- CNAME 链处理
- 缓存清除功能

运行方式：
```bash
cd build
./test_dns_mapping
```

### 3. test_with_data
使用 data/ 目录下的真实流数据进行测试。

测试内容：
- DNS 流（端口 53）
- HTTPS 流（端口 443）
- HTTP 流（端口 80）
- 协议检测
- 域名提取

运行方式：
```bash
cd build
./test_with_data
```

### 4. test_data_advanced
高级数据测试，包含统计分析功能。

测试内容：
- 批量处理 100 个流（50 TCP + 50 UDP）
- 统计信息：
  - 流类型分布
  - 数据包统计
  - 域名提取成功率
  - 协议分布
  - 端口分布
- DNS 缓存功能验证

运行方式：
```bash
cd build
./test_data_advanced
```

## 数据目录结构

```
data/
├── tcp/          # TCP 流数据
│   └── <sessionId>/
│       ├── context.txt    # 流元数据
│       ├── TX_00001.bin   # 发送的数据包
│       ├── TX_00002.bin
│       ├── RX_00001.bin   # 接收的数据包
│       └── RX_00002.bin
└── udp/          # UDP 流数据
    └── <sessionId>/
        ├── context.txt
        ├── TX_00001.bin
        └── RX_00001.bin
```

### context.txt 格式

```
sessionId: 103578995731791
pid: 63607
procPath: /path/to/process
procName: Google Chrome Helper
srcIP: 127.0.0.1
srcPort: 0
dstIP: 220.181.174.34
dstPort: 443
isTCP: YES
```

## 编译所有测试

```bash
mkdir -p build
cd build
cmake ..
make
```

## 测试结果示例

### test_data_advanced 输出示例：

```
FlowCheck 高级数据测试程序
========================================

测试 UDP 流...
测试 TCP 流...

========================================
测试统计
========================================
总流数: 100
  TCP 流: 50
  UDP 流: 50
  DNS 流: 37

总数据包数: 675
  发送包: 387
  接收包: 288

成功提取域名的流: 70 (70%)

协议分布:
  DNS: 37
  HTTPS: 33

端口分布 (Top 10):
  端口 443: 51 个流
  端口 53: 37 个流
  端口 80: 11 个流
  端口 22: 1 个流
```

## 功能验证

### 1. 协议检测
- ✅ DNS 协议检测（端口 53）
- ✅ HTTPS/TLS 协议检测（端口 443）
- ✅ HTTP 协议检测（端口 80）

### 2. 域名提取
- ✅ DNS 查询域名提取
- ✅ DNS 响应域名提取（包括 CNAME）
- ✅ TLS SNI 域名提取
- ✅ HTTP Host 头域名提取

### 3. DNS 缓存
- ✅ DNS 响应缓存
- ✅ DNS 查询缓存命中
- ✅ IP-域名映射
- ✅ 多域名映射到同一 IP

### 4. 架构特性
- ✅ 单例模式
- ✅ 线程安全
- ✅ 函数重载（可选 DNS 响应参数）
- ✅ 成员变量管理（非静态）

## 性能指标

基于 100 个真实流的测试：
- 域名提取成功率：70%
- 支持的协议：DNS, HTTPS, HTTP, SSH
- 处理的数据包：675 个
- 平均每个流：6.75 个数据包

## 注意事项

1. 测试程序需要访问 `/Users//Documents/work/flowcheck/data/` 目录
2. 如果数据目录路径不同，需要修改测试程序中的 `dataDir` 变量
3. `test_data_advanced` 默认限制处理 50 个 TCP 流和 50 个 UDP 流，可以修改代码中的限制
4. 所有测试都使用 FlowEngine 单例，确保 DNS 缓存在测试之间共享

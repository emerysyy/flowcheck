# FlowCheck 架构设计

## 系统概述

FlowCheck 是一个高性能的网络流量检测与分析系统，采用模块化分层架构设计，提供协议检测、域名提取、DNS 缓存等核心功能。

## 架构图

### 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    应用层 (Application)                   │
│                  使用 FlowEngine API                      │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│              FlowEngine (流量引擎 - 单例)                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │  流量生命周期管理                                 │   │
│  │  - flowArrive()  流量到达                        │   │
│  │  - flowOpen()    流量打开                        │   │
│  │  - flowSend()    发送处理                        │   │
│  │  - flowRecv()    接收处理                        │   │
│  │  - flowClose()   流量关闭                        │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                │                          │
                ▼                          ▼
┌──────────────────────────┐  ┌──────────────────────────┐
│   Detector (协议检测器)   │  │   DNSEngine (DNS引擎)    │
│  ┌────────────────────┐  │  │  ┌────────────────────┐ │
│  │ detectProtocol()   │  │  │  │ handleQuery()      │ │
│  │ extractDomain()    │  │  │  │ handleResponse()   │ │
│  └────────────────────┘  │  │  │ getDomainsForIP()  │ │
└──────────────────────────┘  │  │ clearCache()       │ │
                │              │  └────────────────────┘ │
                ▼              └──────────────────────────┘
┌──────────────────────────┐              │
│  Protocol Parsers        │              ▼
│  ┌────────────────────┐  │  ┌──────────────────────────┐
│  │ HTTP Parser        │  │  │  DNSResponseCache        │
│  │ TLS Parser         │  │  │  ┌────────────────────┐ │
│  │ QUIC Parser        │  │  │  │ LRU 缓存           │ │
│  │ SSH Parser         │  │  │  │ TTL 管理           │ │
│  │ FTP Parser         │  │  │  │ 线程安全           │ │
│  │ ...                │  │  │  └────────────────────┘ │
│  └────────────────────┘  │  │                          │
└──────────────────────────┘  │  IP-域名映射表            │
                              │  (多对多关系)             │
                              └──────────────────────────┘
```

## 核心模块

### 1. FlowEngine (流量引擎)

**职责**：
- 流量生命周期管理
- 协议检测调度
- DNS 缓存管理
- 流量决策制定

**设计模式**：
- **单例模式**：全局唯一实例，共享 DNS 缓存
- **外观模式**：统一的流量处理接口

**关键特性**：
- 线程安全的单例实现
- 成员变量管理（dns_engine_, detector_）
- 函数重载支持可选 DNS 响应参数

**代码示例**：
```cpp
class FlowEngine {
public:
    static FlowEngine& getInstance();

    void flowArrive(FlowContext& ctx);
    void flowOpen(FlowContext& ctx);
    void flowSend(FlowContext& ctx, const PacketView& pkt);
    bool flowSend(FlowContext& ctx, const PacketView& pkt, PacketView& response);
    void flowRecv(FlowContext& ctx, const PacketView& pkt);
    void flowClose(FlowContext& ctx);

    DNSEngine& getDNSEngine();

private:
    FlowEngine();
    ~FlowEngine();

    std::unique_ptr<DNSEngine> dns_engine_;
    std::unique_ptr<Detector> detector_;
};
```

### 2. Detector (协议检测器)

**职责**：
- 识别网络协议类型
- 从数据包中提取域名

**支持的协议**：
- HTTP (端口 80)
- HTTPS/TLS (端口 443)
- DNS (端口 53)
- QUIC (端口 443)
- SSH (端口 22)
- FTP (端口 21)
- SMTP (端口 25)
- IMAP (端口 143)
- POP3 (端口 110)
- RTP
- SMB
- TFTP

**检测策略**：
1. 基于端口的初步判断
2. 基于数据包内容的深度检测
3. 协议特征匹配

**代码示例**：
```cpp
class Detector {
public:
    std::string detectProtocol(const FlowContext& ctx, const PacketView& pkt);
    std::string extractDomain(const FlowContext& ctx, const PacketView& pkt);
};
```

### 3. DNSEngine (DNS 引擎)

**职责**：
- DNS 查询处理
- DNS 响应缓存
- IP-域名映射维护

**核心功能**：
1. **查询处理** (`handleQuery`)
   - 解析 DNS 查询包
   - 提取查询域名
   - 缓存查找
   - 返回缓存响应

2. **响应处理** (`handleResponse`)
   - 解析 DNS 响应包
   - 提取多种记录类型
   - 更新缓存
   - 建立 IP-域名映射

3. **IP-域名映射** (`getDomainsForIP`)
   - 支持多对多映射
   - CNAME 链处理
   - 批量映射更新

**数据结构**：
```cpp
class DNSEngine {
private:
    std::unique_ptr<dns::DNSResponseCache> dns_cache_;
    std::unordered_map<std::string, std::vector<std::string>> ip_to_domains_;
    mutable std::mutex mutex_;
};
```

### 4. Protocol Parsers (协议解析器)

**设计原则**：
- 每个协议一个独立的解析器
- 统一的接口设计
- 可扩展架构

**解析器接口**：
```cpp
class ProtocolParser {
public:
    virtual bool isProtocol(const PacketView& pkt) = 0;
    virtual std::string extractDomain(const PacketView& pkt) = 0;
};
```

**实现的解析器**：
- `HTTPParser`: HTTP 协议，提取 Host 头
- `TLSParser`: TLS/HTTPS 协议，提取 SNI
- `QUICParser`: QUIC 协议
- `SSHParser`: SSH 协议
- 等等...

## 数据流

### 出站流量处理流程

```
应用层发送数据
    │
    ▼
flowSend(ctx, pkt)
    │
    ├─→ DNS 查询？
    │   ├─→ 是：handleQuery()
    │   │   ├─→ 缓存命中？
    │   │   │   ├─→ 是：返回缓存响应
    │   │   │   └─→ 否：转发到上游
    │   │   └─→ 提取查询域名
    │   └─→ 否：继续
    │
    ├─→ 协议检测
    │   └─→ detectProtocol()
    │
    ├─→ 域名提取
    │   └─→ extractDomain()
    │       ├─→ HTTP: 提取 Host 头
    │       ├─→ TLS: 提取 SNI
    │       └─→ 其他协议
    │
    └─→ 更新 FlowContext
        └─→ 添加域名到 ctx.domains
```

### 入站流量处理流程

```
接收到响应数据
    │
    ▼
flowRecv(ctx, pkt)
    │
    ├─→ DNS 响应？
    │   ├─→ 是：handleResponse()
    │   │   ├─→ 解析响应
    │   │   ├─→ 提取域名和 IP
    │   │   ├─→ 更新缓存
    │   │   └─→ 建立 IP-域名映射
    │   └─→ 否：继续
    │
    ├─→ 协议检测
    │   └─→ detectProtocol()
    │
    ├─→ 域名提取
    │   └─→ extractDomain()
    │
    └─→ 更新 FlowContext
```

## 关键设计决策

### 1. 单例模式 vs 多实例

**选择**：单例模式

**理由**：
- DNS 缓存需要全局共享
- 避免重复的 DNS 查询
- 简化资源管理
- 保证线程安全

### 2. 函数重载 vs 可选参数

**选择**：函数重载

**理由**：
```cpp
// 方案 A：可选参数（指针）
void flowSend(FlowContext& ctx, const PacketView& pkt, PacketView* response = nullptr);

// 方案 B：函数重载（推荐）
void flowSend(FlowContext& ctx, const PacketView& pkt);
bool flowSend(FlowContext& ctx, const PacketView& pkt, PacketView& response);
```

优势：
- 类型安全（引用不能为空）
- 语义清晰（返回值表示是否有响应）
- 避免空指针检查

### 3. 静态变量 vs 成员变量

**选择**：成员变量

**理由**：
- 更好的面向对象设计
- 便于测试和模拟
- 生命周期管理清晰
- 避免静态初始化顺序问题

### 4. 零拷贝设计

**PacketView 结构**：
```cpp
struct PacketView {
    const uint8_t* data;
    size_t len;
};
```

**优势**：
- 避免数据拷贝
- 减少内存分配
- 提高性能

## 线程安全

### DNS 缓存线程安全

```cpp
class DNSEngine {
private:
    mutable std::mutex mutex_;

public:
    bool handleQuery(...) {
        std::lock_guard<std::mutex> lock(mutex_);
        // 访问缓存
    }

    void handleResponse(...) {
        std::lock_guard<std::mutex> lock(mutex_);
        // 更新缓存
    }
};
```

### 单例线程安全

```cpp
FlowEngine& FlowEngine::getInstance() {
    static FlowEngine instance;  // C++11 保证线程安全
    return instance;
}
```

## 性能优化

### 1. 缓存策略
- LRU 淘汰算法
- TTL 自动过期
- 批量更新减少锁竞争

### 2. 协议检测优化
- 快速路径：基于端口的初步判断
- 慢速路径：深度包检测
- 早期返回：匹配成功立即返回

### 3. 内存管理
- 智能指针自动管理
- 零拷贝数据视图
- 避免不必要的字符串拷贝

## 扩展性

### 添加新协议支持

1. **创建解析器**：
```cpp
// protocol/new_protocol_parser.hpp
class NewProtocolParser {
public:
    bool isProtocol(const PacketView& pkt);
    std::string extractDomain(const PacketView& pkt);
};
```

2. **注册到 Detector**：
```cpp
// flow/flow_detector.cpp
std::string Detector::detectProtocol(...) {
    if (NewProtocolParser::isProtocol(pkt)) {
        return "NewProtocol";
    }
    // ...
}
```

3. **添加测试**：
```cpp
// tests/test_new_protocol.cpp
TEST(NewProtocol, Detection) {
    // 测试代码
}
```

## 错误处理

### 策略
- 防御式编程
- 输入验证
- 优雅降级
- 日志记录（待实现）

### 示例
```cpp
bool DNSEngine::handleQuery(...) {
    if (!pkt.data || pkt.len == 0) {
        return false;  // 无效输入
    }

    try {
        // 处理逻辑
    } catch (...) {
        return false;  // 异常处理
    }
}
```

## 未来改进

### 短期目标
- [ ] 添加日志系统
- [ ] 性能监控和统计
- [ ] 配置文件支持
- [ ] 更多协议支持

### 长期目标
- [ ] 异步处理
- [ ] 分布式缓存
- [ ] 机器学习协议识别
- [ ] 流量分析和可视化

## 总结

FlowCheck 采用清晰的分层架构和模块化设计，具有以下特点：

1. **高性能**：零拷贝、智能缓存、优化的协议检测
2. **可扩展**：模块化设计，易于添加新协议
3. **线程安全**：单例模式、互斥锁保护
4. **易维护**：清晰的接口、完整的文档

这种架构设计使得 FlowCheck 既能满足当前需求，又为未来扩展留有充足空间。

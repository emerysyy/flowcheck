# FlowCheck 项目结构说明

## 目录结构

```
flowcheck/
├── dns/                    # DNS 解析模块
│   ├── dns_cache.cpp      # DNS 响应缓存实现
│   ├── dns_cache.hpp      # DNS 缓存头文件
│   ├── dns_message.cpp    # DNS 消息解析实现
│   └── dns_message.hpp    # DNS 消息头文件
│
├── protocol/              # 协议解析器模块
│   ├── protocol.h         # 协议类型定义
│   ├── http_parser.*      # HTTP 协议解析器
│   ├── tls_parser.*       # TLS/HTTPS 协议解析器
│   ├── quic_parser.*      # QUIC 协议解析器
│   ├── ssh_parser.*       # SSH 协议解析器
│   ├── ftp_parser.*       # FTP 协议解析器
│   ├── smtp_parser.*      # SMTP 协议解析器
│   ├── imap_parser.*      # IMAP 协议解析器
│   ├── pop3_parser.*      # POP3 协议解析器
│   ├── rtp_parser.*       # RTP 协议解析器
│   ├── smb_parser.*       # SMB 协议解析器
│   └── tftp_parser.*      # TFTP 协议解析器
│
├── flow/                  # 流量管理核心模块
│   ├── flow_defines.*     # 基础类型定义
│   ├── flow_engine.*      # 流量引擎（单例）
│   ├── flow_detector.*    # 协议检测器
│   └── flow_dns.*         # DNS 处理引擎
│
├── tests/                 # 测试用例目录
│   ├── test_main.cpp              # 基础功能测试
│   ├── test_dns_mapping.cpp       # DNS 映射测试
│   ├── test_with_data.cpp         # 真实数据测试
│   ├── test_data_advanced.cpp     # 高级统计测试
│   └── test_analyze_failures.cpp  # 失败分析测试
│
├── docs/                  # 项目文档目录
│   ├── 测试说明.md        # 测试用例说明
│   ├── 架构设计.md        # 系统架构设计
│   └── API文档.md         # API 接口文档
│
├── scripts/               # 工具脚本目录
│   ├── scan_invalid_dirs.sh   # 扫描无效流目录
│   └── clean_invalid_dirs.sh  # 清理无效流目录
│
├── data/                  # 测试数据目录
│   ├── tcp/              # TCP 流数据
│   │   └── <sessionId>/
│   │       ├── context.txt    # 流元数据
│   │       ├── TX_*.bin       # 发送数据包
│   │       └── RX_*.bin       # 接收数据包
│   └── udp/              # UDP 流数据
│       └── <sessionId>/
│           ├── context.txt
│           ├── TX_*.bin
│           └── RX_*.bin
│
├── build/                 # 编译输出目录
│   ├── libdns_lib.a          # DNS 静态库
│   ├── libprotocol_lib.a     # 协议解析静态库
│   ├── libflow_lib.a         # 流量管理静态库
│   ├── flowcheck_test        # 基础测试程序
│   ├── test_dns_mapping      # DNS 映射测试
│   ├── test_with_data        # 真实数据测试
│   ├── test_data_advanced    # 高级统计测试
│   └── test_analyze_failures # 失败分析测试
│
├── CMakeLists.txt        # CMake 配置文件
└── README.md             # 项目说明文档
```

## 模块说明

### 1. DNS 模块 (`dns/`)

**功能**：DNS 消息解析和响应缓存

**文件**：
- `dns_message.*`: DNS 消息格式解析，支持多种记录类型
- `dns_cache.*`: LRU 缓存实现，TTL 管理

**依赖**：无外部依赖

### 2. 协议模块 (`protocol/`)

**功能**：各种网络协议的检测和解析

**文件**：
- `protocol.h`: 协议类型枚举定义
- `*_parser.*`: 各协议的解析器实现

**支持的协议**：
- 应用层：HTTP, HTTPS/TLS, FTP, SMTP, IMAP, POP3
- 传输层：QUIC, SSH
- 其他：RTP, SMB, TFTP

**依赖**：无外部依赖

### 3. 流量模块 (`flow/`)

**功能**：流量管理和协议检测的核心逻辑

**文件**：
- `flow_defines.*`: 基础数据结构（FlowContext, PacketView, FlowIP 等）
- `flow_engine.*`: 流量引擎，单例模式，管理流量生命周期
- `flow_detector.*`: 协议检测器，调用各协议解析器
- `flow_dns.*`: DNS 处理引擎，DNS 缓存和 IP-域名映射

**依赖**：dns 模块、protocol 模块

### 4. 测试模块 (`tests/`)

**功能**：各种测试用例

**文件**：
- `test_main.cpp`: 基础功能测试（6 个测试用例）
- `test_dns_mapping.cpp`: DNS IP-域名映射测试
- `test_with_data.cpp`: 使用真实数据的基础测试
- `test_data_advanced.cpp`: 批量测试和统计分析
- `test_analyze_failures.cpp`: 域名提取失败原因分析

**依赖**：flow 模块

### 5. 文档模块 (`docs/`)

**功能**：项目文档

**文件**：
- `测试说明.md`: 测试用例的详细说明和使用方法
- `架构设计.md`: 系统架构、设计模式、数据流
- `API文档.md`: 完整的 API 接口文档和使用示例

### 6. 脚本模块 (`scripts/`)

**功能**：辅助工具脚本

**文件**：
- `scan_invalid_dirs.sh`: 扫描没有 TX 数据包的无效流目录
- `clean_invalid_dirs.sh`: 删除无效流目录

**用途**：数据清理，提高测试质量

## 编译产物

### 静态库

1. **libdns_lib.a** (~38 KB)
   - DNS 消息解析
   - DNS 响应缓存
   - LRU 淘汰策略

2. **libprotocol_lib.a** (~36 KB)
   - 11 种协议解析器
   - 协议检测逻辑
   - 域名提取功能

3. **libflow_lib.a** (~33 KB)
   - 流量引擎（单例）
   - 协议检测器
   - DNS 处理引擎
   - 流量生命周期管理

### 可执行文件

1. **flowcheck_test**
   - 基础功能测试
   - 验证核心 API

2. **test_dns_mapping**
   - DNS IP-域名映射测试
   - 多对多映射验证

3. **test_with_data**
   - 真实数据测试
   - 3 个示例流

4. **test_data_advanced**
   - 批量测试（100 个流）
   - 统计分析
   - 性能指标

5. **test_analyze_failures**
   - 失败原因分析
   - 诊断工具

## 数据流向

```
应用层
  │
  ▼
FlowEngine (单例)
  │
  ├─→ Detector ──→ Protocol Parsers
  │                 (HTTP, TLS, QUIC, ...)
  │
  └─→ DNSEngine
       │
       ├─→ DNSResponseCache (LRU)
       └─→ IP-Domains Mapping
```

## 依赖关系

```
flowcheck_test
  │
  └─→ libflow_lib.a
       │
       ├─→ libdns_lib.a
       └─→ libprotocol_lib.a
```

## 编译流程

```bash
# 1. 配置
cmake ..

# 2. 编译库
make dns_lib          # 编译 DNS 库
make protocol_lib     # 编译协议库
make flow_lib         # 编译流量库

# 3. 编译测试
make flowcheck_test
make test_dns_mapping
make test_with_data
make test_data_advanced
make test_analyze_failures

# 4. 或者一次性编译所有
make -j4
```

## 使用流程

### 1. 开发流程

```bash
# 修改代码
vim flow/flow_engine.cpp

# 重新编译
cd build
make

# 运行测试
./flowcheck_test
```

### 2. 添加新协议

```bash
# 1. 创建解析器
touch protocol/new_protocol_parser.cpp
touch protocol/new_protocol_parser.hpp

# 2. 实现解析逻辑
# 编辑 new_protocol_parser.cpp

# 3. 注册到检测器
# 编辑 flow/flow_detector.cpp

# 4. 更新 CMakeLists.txt
# 添加到 PROTOCOL_SOURCES

# 5. 编译测试
cd build
cmake ..
make
```

### 3. 添加新测试

```bash
# 1. 创建测试文件
touch tests/test_new_feature.cpp

# 2. 编写测试代码
# 编辑 test_new_feature.cpp

# 3. 更新 CMakeLists.txt
# 添加 add_executable 和 target_link_libraries

# 4. 编译运行
cd build
cmake ..
make test_new_feature
./test_new_feature
```

## 文档导航

- **快速开始**：阅读 [README.md](../README.md)
- **API 使用**：阅读 [API文档.md](API文档.md)
- **架构理解**：阅读 [架构设计.md](架构设计.md)
- **测试说明**：阅读 [测试说明.md](测试说明.md)

## 性能指标

基于 1068 个真实流的测试：

| 指标 | 数值 |
|------|------|
| 总流数 | 1068 |
| 总数据包 | 28,000+ |
| 域名提取成功率 | 99% |
| DNS 流识别率 | 100% |
| HTTPS 流识别率 | 100% |
| HTTP 流识别率 | 100% |
| 编译时间 | < 5 秒 |
| 库文件大小 | 107 KB |

## 代码统计

| 类别 | 数量 |
|------|------|
| 源文件 (.cpp) | 17 个 |
| 头文件 (.hpp/.h) | 18 个 |
| 测试文件 | 5 个 |
| 文档文件 | 4 个 |
| 脚本文件 | 2 个 |
| 总代码行数 | ~5000 行 |

## 版本信息

- **版本**：1.0.0
- **创建日期**：2026-02-09
- **C++ 标准**：C++17
- **构建系统**：CMake 3.15+
- **许可证**：Copyright © 2026 WireGuard LLC

## 维护指南

### 代码规范

- 使用 C++17 标准特性
- 遵循 RAII 原则
- 使用智能指针管理内存
- 中文注释
- 4 空格缩进

### 提交规范

- 功能添加：`feat: 添加 XXX 功能`
- Bug 修复：`fix: 修复 XXX 问题`
- 文档更新：`docs: 更新 XXX 文档`
- 测试添加：`test: 添加 XXX 测试`

### 发布流程

1. 更新版本号
2. 更新 CHANGELOG
3. 运行所有测试
4. 生成文档
5. 打包发布

## 常见问题

### Q: 如何添加新的协议支持？
A: 参考 [架构设计.md](架构设计.md) 的"扩展性"章节

### Q: 如何运行测试？
A: 参考 [测试说明.md](测试说明.md)

### Q: 如何使用 API？
A: 参考 [API文档.md](API文档.md)

### Q: 编译失败怎么办？
A: 检查 C++17 编译器支持，查看错误信息

## 联系方式

- 项目维护者：jacky
- 创建日期：2026/2/9

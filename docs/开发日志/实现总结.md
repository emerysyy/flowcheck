# Flow Check Implementation Summary

## Project Overview
This is a network flow detection and analysis system that monitors network traffic, detects protocols, extracts domain names, and makes routing decisions.

## Completed Implementations

### 1. Flow Detector (`flow/flow_detector.cpp`)
**Purpose**: Detect network protocols and extract domain names from packet data.

**Key Functions**:
- `detectProtocol()`: Identifies the protocol type from packet data
  - Supports: DNS, TLS, HTTP, QUIC, SSH, FTP, SMTP, IMAP, POP3
  - Uses protocol-specific parsers for accurate detection
  - Falls back to TCP/UDP based on flow type

- `extractDomain()`: Extracts domain names from protocol-specific data
  - HTTP: Extracts Host header
  - TLS/HTTPS: Extracts SNI (Server Name Indication)
  - Returns domain name if successfully extracted

### 2. DNS Engine (`flow/flow_dns.cpp`)
**Purpose**: Handle DNS queries and responses with caching support.

**Key Functions**:
- `handleQuery()`: Processes DNS queries
  - Parses DNS query packets
  - Extracts domain names from questions
  - Checks DNS cache for existing responses
  - Returns cached response if available (cache hit)

- `handleResponse()`: Processes DNS responses
  - Parses DNS response packets
  - Extracts domains from questions and answers
  - Handles CNAME, PTR, MX, SRV records
  - Stores response in cache for future queries
  - Updates flow context with discovered domains

**Features**:
- Thread-safe DNS response caching
- Supports multiple DNS record types
- Automatic domain extraction from various record types

### 3. Flow Engine (`flow/flow_engine.cpp`)
**Purpose**: Main flow lifecycle management and decision making.

**Key Functions**:
- `flowArrive()`: Initial flow arrival handling
  - Distinguishes between DNS and normal flows
  - Makes initial routing decisions
  - Sets default Allow/Local policy for flows with domains

- `flowOpen()`: Flow connection establishment
  - Initializes per-flow state
  - Validates flow decisions

- `flowSend()`: Outbound packet processing
  - Handles DNS queries with caching
  - Extracts domains from outbound packets (HTTP, TLS)
  - Re-evaluates flow decisions when domain is discovered

- `flowRecv()`: Inbound packet processing
  - Handles DNS responses and caching
  - Extracts domains from inbound packets
  - Updates flow context with discovered information

- `flowClose()`: Flow termination cleanup
  - Cleans up per-flow state

## Architecture

### Flow Processing Pipeline
```
1. Flow Arrives → flowArrive()
   ↓
2. Flow Opens → flowOpen()
   ↓
3. Packet Send → flowSend() → Protocol Detection → Domain Extraction
   ↓
4. Packet Recv → flowRecv() → Protocol Detection → Domain Extraction
   ↓
5. Flow Closes → flowClose()
```

### DNS Flow Handling
```
DNS Query → handleQuery() → Check Cache → Cache Hit? → Return Cached Response
                                        ↓
                                    Cache Miss → Forward Query
                                        ↓
DNS Response → handleResponse() → Parse Response → Store in Cache
                                                 ↓
                                            Extract Domains → Update Context
```

### Protocol Detection Flow
```
Packet Data → detectProtocol() → Protocol-Specific Parser
                                        ↓
                                  Protocol Type Identified
                                        ↓
                                  extractDomain() → Domain Name (if available)
```

## Supported Protocols

### Domain Extraction Support
- **HTTP**: Host header extraction
- **TLS/HTTPS**: SNI (Server Name Indication) extraction

### Protocol Detection Support
- DNS (port-based)
- TLS/SSL
- HTTP/HTTPS
- QUIC
- SSH
- FTP
- SMTP
- IMAP
- POP3
- Generic TCP/UDP

## Key Features

1. **Multi-Protocol Support**: Detects and handles various network protocols
2. **Domain Extraction**: Extracts domain names from HTTP and TLS traffic
3. **DNS Caching**: Caches DNS responses to reduce latency and network traffic
4. **Flow Decision Making**: Makes routing decisions (Allow/Block, Direct/Local/Gateway)
5. **Dynamic Protocol Detection**: Identifies protocols from packet content, not just ports
6. **Thread-Safe**: DNS cache operations are thread-safe

## Data Structures

### FlowContext
- Session information (ID, timestamp, PID, process info)
- Flow type (TCP/UDP/DNS) and direction (Inbound/Outbound)
- Destination IP and port
- Discovered domains
- Flow and path decisions

### PacketView
- Raw packet data pointer and length
- Zero-copy view of packet data

## Decision Making

### Flow Decisions
- **Allow**: Flow is permitted
- **Block**: Flow is blocked

### Path Decisions
- **None**: No path assigned
- **Direct**: Direct connection
- **Local**: Local proxy/gateway
- **Gateway**: Remote gateway

## Implementation Notes

1. **Static Instances**: DNS engine and detector use static instances for efficiency
2. **Lazy Initialization**: DNS cache is created on first use
3. **Protocol Priority**: TLS detection before HTTP to catch HTTPS traffic
4. **Port-Based Hints**: DNS uses port 53 for quick identification
5. **Domain Accumulation**: Multiple domains can be associated with a single flow

## Future Enhancements

Potential areas for improvement:
- Add more protocol parsers (RTP, SMB, TFTP)
- Implement custom routing rules based on domains
- Add metrics and statistics collection
- Support for encrypted DNS (DoH, DoT)
- Advanced caching strategies (TTL-based expiration)
- Flow classification and QoS support

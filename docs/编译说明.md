# FlowCheck 编译说明

## 项目配置

### CMake 配置
- **CMake 最低版本**: 3.15
- **C++ 标准**: C++17
- **编译器**: AppleClang 16.0.0.16000026
- **构建类型**: Release (-O3 优化)

## 项目结构

### 生成的库文件

项目被组织为三个静态库：

1. **libdns_lib.a** (38KB)
   - DNS 缓存管理
   - DNS 消息解析
   - 源文件：
     - `dns/dns_cache.cpp`
     - `dns/dns_message.cpp`

2. **libprotocol_lib.a** (36KB)
   - 多协议解析器
   - 源文件：
     - `protocol/ftp_parser.cpp`
     - `protocol/http_parser.cpp`
     - `protocol/imap_parser.cpp`
     - `protocol/pop3_parser.cpp`
     - `protocol/quic_parser.cpp`
     - `protocol/rtp_parser.cpp`
     - `protocol/smb_parser.cpp`
     - `protocol/smtp_parser.cpp`
     - `protocol/ssh_parser.cpp`
     - `protocol/tftp_parser.cpp`
     - `protocol/tls_parser.cpp`

3. **libflow_lib.a** (33KB)
   - 流量管理引擎
   - 流量检测器
   - DNS 流量处理
   - 源文件：
     - `flow/flow_defines.cpp`
     - `flow/flow_detector.cpp`
     - `flow/flow_dns.cpp`
     - `flow/flow_engine.cpp`

## 编译步骤

### 1. 创建构建目录并配置
```bash
mkdir -p build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
```

### 2. 编译
```bash
make -j$(sysctl -n hw.ncpu)
```

### 3. 清理重新编译
```bash
cd build
make clean
make -j$(sysctl -n hw.ncpu)
```

### 4. 完全重新构建
```bash
rm -rf build
mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(sysctl -n hw.ncpu)
```

## 编译结果

### 成功编译
✅ 所有源文件编译成功
✅ 生成三个静态库文件
✅ 无编译错误

### 编译警告
编译过程中有一些次要警告（不影响功能）：

1. **未使用的参数警告**
   - `ftp_parser.cpp:68`: 未使用的 `length` 参数
   - `ssh_parser.cpp:72`: 未使用的 `data` 和 `length` 参数
   - `flow_engine.cpp:132`: 未使用的 `ctx` 参数

2. **未使用的变量警告**
   - `dns_message.cpp:226`: 未使用的变量 `q`
   - `dns_message.cpp:233`: 未使用的变量 `rr`

这些警告可以通过以下方式修复：
- 使用 `[[maybe_unused]]` 属性
- 使用 `(void)variable;` 语句
- 或者移除未使用的参数名称

## 库依赖关系

```
flow_lib
  ├── dns_lib
  └── protocol_lib
```

`flow_lib` 依赖于 `dns_lib` 和 `protocol_lib`。

## 使用方法

### 在其他项目中使用这些库

```cmake
# 在你的 CMakeLists.txt 中
include_directories(/path/to/flowcheck)
link_directories(/path/to/flowcheck/build)

add_executable(your_app main.cpp)
target_link_libraries(your_app flow_lib dns_lib protocol_lib)
```

### 示例代码

```cpp
#include "flow/flow_engine.hpp"
#include "flow/flow_defines.h"

int main() {
    flow::FlowEngine engine;
    flow::FlowContext ctx;

    // 设置流量上下文
    ctx.dst_port = 443;
    ctx.flow_type = flow::FlowType::TCP;

    // 处理流量到达
    engine.flowArrive(ctx);

    // 处理数据包
    flow::PacketView pkt;
    pkt.data = /* your packet data */;
    pkt.len = /* packet length */;

    engine.flowSend(ctx, pkt);

    return 0;
}
```

## 编译器标志

### Release 模式
- `-O3`: 最高级别优化
- `-DNDEBUG`: 禁用断言
- `-Wall -Wextra`: 启用所有警告

### Debug 模式
```bash
cmake .. -DCMAKE_BUILD_TYPE=Debug
```
- `-g`: 包含调试信息
- `-O0`: 无优化

## 安装

```bash
cd build
sudo make install
```

这将安装：
- 库文件到 `/usr/local/lib`
- 头文件到 `/usr/local/include/flowcheck/`

## 构建输出位置

- **库文件**: `build/lib*.a`
- **目标文件**: `build/CMakeFiles/*/`
- **CMake 缓存**: `build/CMakeCache.txt`

## 系统要求

- **操作系统**: macOS (Darwin 24.6.0)
- **编译器**: Clang 16.0+ 或 GCC 7.0+
- **CMake**: 3.15+
- **C++ 标准**: C++17

## 故障排除

### 问题：找不到头文件
**解决方案**: 确保包含目录正确设置
```cmake
include_directories(${CMAKE_SOURCE_DIR})
```

### 问题：链接错误
**解决方案**: 确保链接顺序正确
```cmake
target_link_libraries(your_target flow_lib dns_lib protocol_lib)
```

### 问题：C++17 特性不可用
**解决方案**: 检查编译器版本
```bash
c++ --version
```

## 性能优化

当前配置已启用：
- ✅ C++17 标准特性
- ✅ Release 模式 O3 优化
- ✅ 静态库链接（减少运行时开销）
- ✅ 多核并行编译

## 下一步

1. 创建主程序 `main.cpp` 来使用这些库
2. 添加单元测试
3. 创建示例程序
4. 添加性能基准测试

## 编译统计

- **总源文件数**: 17 个 .cpp 文件
- **生成库数量**: 3 个静态库
- **总代码大小**: ~107 KB (压缩后)
- **编译时间**: < 5 秒（8核并行）
- **警告数量**: 5 个（非致命）
- **错误数量**: 0
